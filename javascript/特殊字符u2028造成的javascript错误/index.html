<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  
  <title>特殊字符u2028造成的javascript错误 | Main.Weaver.Christopher.Diary | 魁主编的全栈训练营</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="theme-color" content="#3F51B5">
  
  
  <meta name="keywords" content="Javascript,编码">
  <meta name="description" content="特殊字符u2028造成的javascript错误症状运用selenium RemoteWebDriver驱动phantomjs执行javascript脚本时，phantomjs抛出异常：123456789101112[ERROR - 2017-04-12T03:36:45.349Z] Session [feec3570-1f2a-11e7-8c8f-2d5cfc43fe3a] - page.onE">
<meta name="keywords" content="Javascript,编码">
<meta property="og:type" content="article">
<meta property="og:title" content="特殊字符u2028造成的javascript错误">
<meta property="og:url" content="https://christopher-ustb.github.io/dev-log/javascript/特殊字符u2028造成的javascript错误/index.html">
<meta property="og:site_name" content="Main.Weaver.Christopher.Diary">
<meta property="og:description" content="特殊字符u2028造成的javascript错误症状运用selenium RemoteWebDriver驱动phantomjs执行javascript脚本时，phantomjs抛出异常：123456789101112[ERROR - 2017-04-12T03:36:45.349Z] Session [feec3570-1f2a-11e7-8c8f-2d5cfc43fe3a] - page.onE">
<meta property="og:updated_time" content="2018-01-13T07:15:27.874Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="特殊字符u2028造成的javascript错误">
<meta name="twitter:description" content="特殊字符u2028造成的javascript错误症状运用selenium RemoteWebDriver驱动phantomjs执行javascript脚本时，phantomjs抛出异常：123456789101112[ERROR - 2017-04-12T03:36:45.349Z] Session [feec3570-1f2a-11e7-8c8f-2d5cfc43fe3a] - page.onE">
  
    <link rel="alternative" href="/atom.xml" title="Main.Weaver.Christopher.Diary" type="application/atom+xml">
  
  <meta name="summary" content="水货开发者的鱼塘遨游日志">
  <link rel="shortcut icon" href="/dev-log/favicon.ico">
  <link rel="stylesheet" href="/dev-log/css/style.css?v=1.1.7">
</head>

<body>
  <div id="loading" class="active"></div>

  <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      <div class="brand">
        <a href="/" class="avatar"><img src="/dev-log/img/logo.jpg"></a>
        <hgroup class="introduce">
          <h5 class="nickname">Christopher.Wang</h5>
          <a href="mailto:wangchao_ustb_2012@163.com" title="wangchao_ustb_2012@163.com" class="mail">wangchao_ustb_2012@163.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/dev-log/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/dev-log/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                文章
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/dev-log/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/dev-log/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                分类
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/christopher-ustb" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/dev-log/thanks"  >
                <i class="icon icon-lg icon-link"></i>
                致谢
              </a>
            </li>
        
      </ul>

      <footer class="footer">
  <p><a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0;vertical-align:middle;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAAllBMVEUAAAD///+rsapERER3d3eIiIjMzMzu7u4iIiKUmZO6v7rKzsoODg4RERFVVVUNDQ0NDg0PEA8zMzNLTEtbXltmZmZydnF9gn2AgICPkI+ZmZmqqqq7u7vFxsXIzMgNDQwZGRkgICAhISEkJSMnKCcuMC4xMzE5Ozk7PTtBQkFCQkJDQ0Nna2eGhoaHh4ezuLLGysbd3d1wVGpAAAAA4UlEQVR42q2T1xqCMAyFk7QsBQeKA9x7j/d/OSm22CpX0nzcpA1/T05aAOuBVkMAScQFHLnEwoCo2f1TnQIGoVMewjZEjVFN4GH1Ue1Cn2jWqwfsOOj6wDwGvotsl/c8lv7KIq1eLOsT0HMFHMIE/RZyHnlphryT9zyV+8WH5e8yQw3wnQvgAFxPTKUVi555SHR/lOfLMgVTeDlSfN+TaoUsiTyeIm+bCkHvCA2FUKG48LDtYBZBknsYP/G8NTw0gaaHyuQf4H5pecrB/FYCT2sL9zAfy1Xyjou6L8X2W7YcLyBZCRtnq/zfAAAAAElFTkSuQmCC" /></a></p>
  <p>Main.Weaver.Christopher.Diary &copy; 2019</p>
  <p>Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme
  <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a></p>
  <a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-2x icon-rss-square"></i></a>
</footer>

    </div>
  </div>
</aside>
  <main id="main">
    <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">特殊字符u2028造成的javascript错误</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-share">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container">
        <h1 class="title">特殊字符u2028造成的javascript错误</h1>
        
        

    </div>

    

</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#特殊字符u2028造成的javascript错误"><span class="post-toc-number">1.</span> <span class="post-toc-text">特殊字符u2028造成的javascript错误</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#症状"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">症状</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#背景知识学习"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">背景知识学习</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#RemoteWebDriver"><span class="post-toc-number">1.2.1.</span> <span class="post-toc-text">RemoteWebDriver</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#selenium-remote"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">selenium-remote</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#问题追踪"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">问题追踪</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#问题总结"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">问题总结</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#修复问题"><span class="post-toc-number">1.6.</span> <span class="post-toc-text">修复问题</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Reference"><span class="post-toc-number">1.7.</span> <span class="post-toc-text">Reference</span></a></li></ol></li></ol>
        </nav>
    </aside>
    
<article id="post-javascript/特殊字符u2028造成的javascript错误" 
  class="post-article article-type-post" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">特殊字符u2028造成的javascript错误</h1>
        <div class="post-meta">
            <time datetime="2017-04-11T16:00:00.000Z" itemprop="datePublished" class="post-time">
  2017-04-12
</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/dev-log/categories/Javascript/">Javascript</a></li></ul>



        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h1 id="特殊字符u2028造成的javascript错误"><a href="#特殊字符u2028造成的javascript错误" class="headerlink" title="特殊字符u2028造成的javascript错误"></a>特殊字符u2028造成的javascript错误</h1><h2 id="症状"><a href="#症状" class="headerlink" title="症状"></a>症状</h2><p>运用selenium RemoteWebDriver驱动phantomjs执行javascript脚本时，phantomjs抛出异常：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[ERROR - 2017-04-12T03:36:45.349Z] Session [feec3570-1f2a-11e7-8c8f-2d5cfc43fe3a] - page.onError - msg: SyntaxError: Unexpected EOF</span><br><span class="line"></span><br><span class="line">  :262 in error</span><br><span class="line">[ERROR - 2017-04-12T03:36:45.350Z] Session [feec3570-1f2a-11e7-8c8f-2d5cfc43fe3a] - page.onError - stack:</span><br><span class="line">  evaluateJavaScript (phantomjs://webpage.evaluate():14)</span><br><span class="line">  evaluate (:387)</span><br><span class="line">  _executeCommand (:/ghostdriver/request_handlers/session_request_handler.js:404)</span><br><span class="line">  _handle (:/ghostdriver/request_handlers/session_request_handler.js:142)</span><br><span class="line">  _reroute (:/ghostdriver/request_handlers/request_handler.js:61)</span><br><span class="line">  _handle (:/ghostdriver/request_handlers/router_request_handler.js:78)</span><br><span class="line"></span><br><span class="line">  :262 in error</span><br></pre></td></tr></table></figure></p>
<h2 id="背景知识学习"><a href="#背景知识学习" class="headerlink" title="背景知识学习"></a>背景知识学习</h2><h3 id="RemoteWebDriver"><a href="#RemoteWebDriver" class="headerlink" title="RemoteWebDriver"></a>RemoteWebDriver</h3><p>RemoteWebDriver是一个远程控制浏览器的规范接口。它提供了跨平台-语言无关的远距离查看与控制浏览器状态与行为的协议。</p>
<p>它提供了一系列的接口，来发现与操作网页中的dom元素，以及控制user agent的行为。它的原始意图是允许网站作者能够写出以一个单独的进程控制的自动化测试，也可以用作运行在浏览器内部的脚本来控制其他独立的浏览器。</p>
<p>比如：</p>
<ul>
<li>POST /session 新建会话</li>
<li>POST /session/{session id}/url 修改浏览器的地址并转向</li>
<li>POST /session/{session id}/refresh 刷新</li>
<li>POST /session/{session id}/elements 查找元素</li>
<li>POST /session/{session id}/element/{element id}/click 点击元素</li>
<li>POST /session/{session id}/execute/sync 同步执行脚本</li>
</ul>
<p>可以看出，RemoteWebDriver试图模拟人类用户对浏览器的大部分操作，以实现自动化测试的目的。</p>
<h2 id="selenium-remote"><a href="#selenium-remote" class="headerlink" title="selenium-remote"></a>selenium-remote</h2><p>在了解了RemoteWebDriver的基本原理之后，selenium-remote的功能就已经呼之欲出了：封装对RemoteWebDriver的访问过程，管理session，简化开发。</p>
<p>在debug了一遍其源代码之后，总结其主要功能有：</p>
<ul>
<li>利用命令行启动phantomjs进程，如何调用<code>GET /status</code>接口查看其是否启动完成</li>
<li>管理session，对应的WebDriver对象</li>
<li>组织http request</li>
<li>利用Apache http client发送请求</li>
<li>解析http response，包括成功结果与错误信息</li>
</ul>
<h2 id="问题追踪"><a href="#问题追踪" class="headerlink" title="问题追踪"></a>问题追踪</h2><ol>
<li><p>在了解了selenium-remote的基本原理后，怀疑其组织http request或解析http response有问题，将运行过程中的http request数据完全复制出来，拿到另外的发包工具（Fiddler）里发送后，得到如下错误：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;errorMessage&quot;: &quot;Command failed without producing the expected error report&quot;,</span><br><span class="line">  &quot;request&quot;: &#123;</span><br><span class="line">    &quot;headers&quot;: &#123;</span><br><span class="line">      &quot;Accept&quot;: &quot;application/json, image/png&quot;,</span><br><span class="line">      &quot;Connection&quot;: &quot;Keep-Alive&quot;,</span><br><span class="line">      &quot;Content-Length&quot;: &quot;136661&quot;,</span><br><span class="line">      &quot;Content-Type&quot;: &quot;application/json; charset=utf-8&quot;,</span><br><span class="line">      &quot;Host&quot;: &quot;localhost:26246&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;httpVersion&quot;: &quot;1.1&quot;,</span><br><span class="line">    &quot;method&quot;: &quot;POST&quot;,</span><br><span class="line">    &quot;post&quot;: &quot;&#123;\&quot;args\&quot;:[],\&quot;script\&quot;:&quot;实际的js语句&quot;,</span><br><span class="line">    &quot;url&quot;: &quot;/execute&quot;,</span><br><span class="line">    &quot;urlParsed&quot;: &#123;</span><br><span class="line">      &quot;anchor&quot;: &quot;&quot;,</span><br><span class="line">      &quot;query&quot;: &quot;&quot;,</span><br><span class="line">      &quot;file&quot;: &quot;execute&quot;,</span><br><span class="line">      &quot;directory&quot;: &quot;/&quot;,</span><br><span class="line">      &quot;path&quot;: &quot;/execute&quot;,</span><br><span class="line">      &quot;relative&quot;: &quot;/execute&quot;,</span><br><span class="line">      &quot;port&quot;: &quot;&quot;,</span><br><span class="line">      &quot;host&quot;: &quot;&quot;,</span><br><span class="line">      &quot;password&quot;: &quot;&quot;,</span><br><span class="line">      &quot;user&quot;: &quot;&quot;,</span><br><span class="line">      &quot;userInfo&quot;: &quot;&quot;,</span><br><span class="line">      &quot;authority&quot;: &quot;&quot;,</span><br><span class="line">      &quot;protocol&quot;: &quot;&quot;,</span><br><span class="line">      &quot;source&quot;: &quot;/execute&quot;,</span><br><span class="line">      &quot;queryKey&quot;: &#123;&#125;,</span><br><span class="line">      &quot;chunks&quot;: [</span><br><span class="line">        &quot;execute&quot;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;urlOriginal&quot;: &quot;/session/010c8a30-1c06-11e7-bf38-73a6c09b43c0/execute&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 基本看不出错误的原因，但是可以排除是类库组织http request的问题。</p>
</li>
<li><p>查看phantomjs日志</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[ERROR - 2017-04-12T03:36:45.349Z] Session [feec3570-1f2a-11e7-8c8f-2d5cfc43fe3a] - page.onError - msg: SyntaxError: Unexpected EOF</span><br><span class="line"></span><br><span class="line">  :262 in error</span><br><span class="line">[ERROR - 2017-04-12T03:36:45.350Z] Session [feec3570-1f2a-11e7-8c8f-2d5cfc43fe3a] - page.onError - stack:</span><br><span class="line">  evaluateJavaScript (phantomjs://webpage.evaluate():14)</span><br><span class="line">  evaluate (:387)</span><br><span class="line">  _executeCommand (:/ghostdriver/request_handlers/session_request_handler.js:404)</span><br><span class="line">  _handle (:/ghostdriver/request_handlers/session_request_handler.js:142)</span><br><span class="line">  _reroute (:/ghostdriver/request_handlers/request_handler.js:61)</span><br><span class="line">  _handle (:/ghostdriver/request_handlers/router_request_handler.js:78)</span><br><span class="line"></span><br><span class="line">  :262 in error</span><br></pre></td></tr></table></figure>
<p> 这个错误也相当模糊，看上去是js语法出现了问题。</p>
</li>
<li><p>将运行的js代码复制到chrome控制台执行，这时候才第一次仔细观察要执行的js语句。</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.articles = [&#123;<span class="string">"id"</span>:<span class="number">26802</span>,<span class="string">"title"</span>:<span class="string">"猫驯记_12_小白"</span>,<span class="string">"content"</span>:<span class="string">"&lt;div class=\"show-content\"&gt;\n          &lt;blockquote&gt;&lt;p&gt;猫也是人类最好的朋友，但它们绝不会屈尊承认这件事。&lt;br&gt; \u2014\u2014Doug Larson，作家&lt;\/p&gt;&lt;\/blockquote&gt;\n&lt;p&gt;很久以前的那只小白猫似乎没有这么活泼。不知道是星座、血型还是性别原因\u2026\u2026反正小白就是比较沉稳。对，他叫小白。&lt;\/p&gt;\n&lt;p&gt;那时我在一个旧小区里租了套旧房子住，房东是个酷爱安利产品、并且将推广安利视为人生目标的老太太。安利老太太本来打算把这套房子按照学校宿舍风格装修\u2014\u2014在所有空间里都摆上双层铁架床，而且尽量省钱\u2014\u2014不过可能是高估了租客对双层床的偏好，最终剩下大堆床架床板，都胡乱塞在厅里。&lt;\/p&gt;\n&lt;p&gt;那套房间在一楼，空间不大，阳光不多，水泥地面冰凉。厨房和洗手间几乎是原生态，木门上涂了层黄漆，早已片片斑驳。&lt;\/p&gt;\n&lt;p&gt;小白第一次看见这套房子，抬头看了看我，然后往我手里吐了个泡泡。那天天气很热，他中暑了。&lt;\/p&gt;\n&lt;p&gt;当时小白很小，才和我手掌差不多长。尾巴细细瘦瘦，脑袋大大的，总是睁一只眼闭一只眼。脑袋上一小撮黑毛滑稽地竖着，身上的白毛还不够长，能看见粉红色的皮肤。&lt;\/p&gt;\n&lt;p&gt;小白在我手里不住吐泡泡，口水把下巴洇湿了一片。我也没什么经验，只能捧着他走来走去通风，帮他擦嘴角的口水。又倒了点水端到他嘴边，直到他开始喝水，才放心了下来。&lt;\/p&gt;\n&lt;p&gt;我去跟附近工地的工人们要了些沙子，又去买了点肉。回到家，发现小白不见了。&lt;\/p&gt;\n&lt;p&gt;那套房子基本上一览无余。两个旧沙发、一张折叠桌，剩下就是几张双层床。窗户和门都关好了，小家伙能跑到哪里去呢？&lt;\/p&gt;\n&lt;p&gt;不在厨房，也不在洗手间。唯一的可能，就是在那堆床板床架里。&lt;\/p&gt;\n&lt;p&gt;\u201c喵？\u201d我叫。&lt;\/p&gt;\n&lt;p&gt;没有回应。&lt;\/p&gt;\n&lt;p&gt;那堆床板床架结构很复杂，充满巧夺天工的随意感，像是实体化的混沌。我不敢动任何一块，因为那东西倒下来的方向和位置完全无法预测。我只能向每个缝隙里张望，点亮手机屏幕来照明，一边喵喵叫个不停。&lt;\/p&gt;\n&lt;p&gt;该死，我甚至连个手电都没有。&lt;\/p&gt;\n&lt;p&gt;我在考虑要不要去买个手电的时候，听到一声细细的\u201c喵~~\u201d。声音弱得让我怀疑自己幻听。&lt;\/p&gt;\n&lt;p&gt;\u201c喵~~\u201d又一声，细细弱弱怯生生的。是真的。&lt;\/p&gt;\n&lt;p&gt;我终于看见小白，在靠墙的角落里，紧贴着墙。两只大眼睛望着我，小下巴微微发抖。&lt;\/p&gt;\n&lt;p&gt;可是我够不着他。&lt;\/p&gt;\n&lt;p&gt;我坐在地上，和小白隔着一大堆杂物沟通。&lt;\/p&gt;\n&lt;p&gt;\u201c过来吧，来喝水？\u201d&lt;\/p&gt;\n&lt;p&gt;\u201c过来，来吃肉？\u201d\u2028&lt;\/p&gt;\n&lt;p&gt;小白惊恐地望着我。&lt;\/p&gt;\n&lt;p&gt;\u201c乖，来，要上厕所吗？\u201d我尽可能把声调再调整柔和一点。&lt;\/p&gt;\n&lt;p&gt;小白犹犹豫豫走近了两步，站住了。我伸出手，他又退后两步。&lt;\/p&gt;\n&lt;p&gt;我们就这样僵持了一下午。直到第二天早上，小白还缩在杂物堆里，偶尔轻轻叫一声。&lt;\/p&gt;\n&lt;p&gt;我下班回来，才看见杂物堆里探出一颗小脑袋，圆溜溜两只眼睛盯着我。头顶上的一撮黑毛还竖着，身上的颜色像是用久了的白麻布。&lt;\/p&gt;\n&lt;p&gt;\u201c小白？\u201d我慢慢走近。&lt;\/p&gt;\n&lt;p&gt;\u201c喵~~\u201d他回应，退后了一步，站住了。&lt;\/p&gt;\n&lt;p&gt;我伸手把他抱起来，他没躲开。小肚子扁扁的，细细的小肋骨根根分明。&lt;\/p&gt;\n&lt;p&gt;\u201c我们是室友啦。\u201d我对他说，\u201c请多多关照啊。\u201d&lt;\/p&gt;\n&lt;p&gt;小白的肚子贴在我手心，轻轻叫了一声。&lt;\/p&gt;\n\n        &lt;\/div&gt;"</span>&#125;];<span class="built_in">window</span>.pageSizeId = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p> 敏锐的观察到，其中有些很奇怪的Unicode字符。我好好的发送http请求，为什么要把我的字符转化为Unicode形式呢，看来还是组织http request的代码出了问题。</p>
</li>
<li><p>跟踪selenium-remote源码，发现其使用的json化工具org.json:json会将某些字符转化为Unicode</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">if</span> (c &lt; <span class="string">' '</span> || (c &gt;= <span class="string">'\u0080'</span> &amp;&amp; c &lt; <span class="string">'\u00a0'</span>) ||</span><br><span class="line">                   (c &gt;= <span class="string">'\u2000'</span> &amp;&amp; c &lt; <span class="string">'\u2100'</span>)) &#123;</span><br><span class="line">        t = <span class="string">"000"</span> + Integer.toHexString(c);</span><br><span class="line">        sb.append(<span class="string">"\\u"</span> + t.substring(t.length() - <span class="number">4</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sb.append(c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>尝试缩小js范围，将每个Unicode替换为其实际字符，最后发现/u2028不是正常字符，而是一个Line Separator。反复对比后发现，这个字符是造成phantomjs执行js报错的直接导火索。</p>
</li>
<li><p>找出直接原因，u2028为行分隔符，而javascript中字符串表达式不允许换行，从而导致执行错误。</p>
</li>
</ol>
<h2 id="问题总结"><a href="#问题总结" class="headerlink" title="问题总结"></a>问题总结</h2><p>这里javascript对行分隔符的解析，可以看出一个动态语言的尴尬之处：<br>不同于Java等静态语言，由于这个javascript表达式是运行时生成的，所以解释器很难判断出，这个行分隔符是源代码中作者在试图换行，还是字符串的内容包含了航分隔符。<br>显然，这里javascript解释器认为脚本中包含了一个包含真正断行，而不是行分隔符的字符串表达式，于是判定为语法错误。</p>
<p>而这个数据的来源，可能是Java语言，在处理这个字符串的过程中，就不存在这个问题，于是可以顺利得将数据传递到这里交由javascript执行。</p>
<p>那么问题来了，javascript中，到底要如何表示多行字符串呢？</p>
<p>可行的方法：</p>
<ol>
<li><p>手动\n</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> multiple_lines = <span class="string">"举头望明月\n低头思故乡"</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>结尾反斜线</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> multiple_lines = <span class="string">"举头望明月\</span></span><br><span class="line"><span class="string">                      低头思故乡"</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>字符串join(‘\n’)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> multiple_lines = [<span class="string">"举头望明月"</span>, <span class="string">"低头思故乡"</span>].join(<span class="string">'\n'</span>);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="修复问题"><a href="#修复问题" class="headerlink" title="修复问题"></a>修复问题</h2><p>在数据源头将u2048字符删去</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><p><a href="https://w3c.github.io/webdriver/webdriver-spec.html" target="_blank" rel="noopener">WebDriver</a></p>
</li>
<li><p><a href="http://www.cnblogs.com/rrooyy/p/5349978.html" target="_blank" rel="noopener">特殊字符_u2028导致的Javascript脚本异常 - 良村 - 博客园</a></p>
</li>
<li><p><a href="http://jser.me/2013/08/20/javascript%E7%9A%84%E5%87%A0%E7%A7%8D%E4%BD%BF%E7%94%A8%E5%A4%9A%E8%A1%8C%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%96%B9%E5%BC%8F.html" target="_blank" rel="noopener">javascript的几种使用多行字符串的方式</a></p>
</li>
</ul>

        </div>
        
        <blockquote class="post-copyright">
            <div class="content">
               原创作品，允许转载，转载时务必以链接形式标明文章出处、作者信息以及本声明，否则将追究法律责任。<a href="/dev-log/javascript/特殊字符u2028造成的javascript错误/" target="_blank" rel="external">https://christopher-ustb.github.io/dev-log/javascript/特殊字符u2028造成的javascript错误/</a>
            </div>
            <footer>
                <a href="https://christopher-ustb.github.io/dev-log">
                    <img src="/dev-log/img/logo.jpg" alt="Christopher.Wang">
                    Christopher.Wang
                </a>
            </footer>
        </blockquote>

        
        <div class="post-reward">
            <a id="rewardBtn" href="javascript:;" class="post-reward-btn waves-effect waves-circle waves-light">赏</a>
        </div>
        

        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/dev-log/tags/Javascript/">Javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/dev-log/tags/编码/">编码</a></li></ul>


            
            <div class="post-share-wrap">
                <div class="post-share" id="post-share">
    <div class="tit">分享到：</div>
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" href="javascript:;" data-title="微博" data-service="tsina">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns" href="javascript:;" data-title="微信" data-service="weixin">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" href="javascript:;" data-title=" QQ" data-service="cqq">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" href="javascript:;" data-title=" Facebook" data-service="fb">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" href="javascript:;" data-title=" Twitter" data-service="twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="douban share-sns" href="javascript:;" data-title="豆瓣" data-service="douban">
          豆
        </a>
      </li>
    </ul>
 </div>

                <a href="javascript:;" id="share-fab" class="post-share-fab waves-effect waves-circle">
                    <i class="icon icon-share-alt icon-lg"></i>
                </a>
            </div>
            

        </div>
    </div>   

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/dev-log/design/请停止误用http-patch/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">请停止误用http-patch</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/dev-log/java/spring/spring源代码学习笔记/1IOC容器之根接口BeanFactory/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">IOC容器之根接口BeanFactory</h4>
      </a>
    </div>
  
</nav>


            
    



</article>

<div id="reward" class="reward-lay">
    <a class="reward-off" id="rewardOff" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        谢谢大爷~
        <i class="icon icon-quote-right"></i>
    </h3>
    <ul class="reward-items">
        
        <li>
            <img src="/dev-log/images/reward/wechat.jpg" title="微信打赏二维码" alt="微信打赏二维码">
            <p>微信</p>
        </li>
        

        
        <li>
            <img src="/dev-log/images/reward/alipay.jpg" title="支付宝打赏二维码" alt="支付宝打赏二维码">
            <p>支付宝</p>
        </li>
        
    </ul>
</div>


</div>
  </main>
  <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>

<script>var BLOG = { ROOT: '/dev-log/' };
BLOG.SHARE = {
title: "特殊字符u2028造成的javascript错误",
pic: "/dev-log/img/logo.jpg",
summary: document.getElementsByName('summary')[0].content,
url: "https://christopher-ustb.github.io/dev-log/javascript/特殊字符u2028造成的javascript错误/" }
</script>
<div class="global-share" id="global-share">
    <div class="tit">分享到：</div>
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" href="javascript:;" data-title="微博" data-service="tsina">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns" href="javascript:;" data-title="微信" data-service="weixin">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" href="javascript:;" data-title=" QQ" data-service="cqq">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" href="javascript:;" data-title=" Facebook" data-service="fb">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" href="javascript:;" data-title=" Twitter" data-service="twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="douban share-sns" href="javascript:;" data-title="豆瓣" data-service="douban">
          豆
        </a>
      </li>
    </ul>
 </div>


  <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script src="/dev-log/js/main.min.js?v=1.1.7"></script>



<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/dev-log/js/search.min.js?v=1.1.7"></script>









</body>
</html>
