---
title: 虚拟机字节码执行引擎
date: 2016-10-29 21:05:59
categories: 
- Java
tags:
- java
- jvm
- 读书笔记
---

# 虚拟机字节码执行引擎

## 概述

执行引擎是Java虚拟机的最核心组成部分。JVM规范制定了字节码执行引擎的模型概念，称为执行引擎的统一外观(Facade)：输入的是字节码文件，处理过程是字节码解析的等效过程，输出的是执行结果。

## 运行时栈帧结构

栈帧(Stack Frame)是用于支持虚拟机进行方法调用和方法执行的数据结构，它是虚拟机运行时数据区中的虚拟机栈(Virtual Machine Stack)的栈元素。

每个方法从调用开始到执行完成的过程，都对应着一个栈帧在虚拟机栈从入栈到出栈的过程。

在编译程序代码的时候，栈帧中需要多大的局部变量表、多深的操作数栈都已经完全确定了，并且写入到方法表的Code属性之中(参考[类文件结构](./类文件结构))，因此一个栈帧需要分配多少内存，不会受到程序运行期间变量数据的影响，仅仅取决于具体的jvm实现。

一个线程中的方法调用链可能很长，对活动线程来说，只有位于栈顶的栈帧才是有效的，称之为当前栈帧(Current Stack Frame)，与这个栈帧相关联的方法称为当前方法(Current Method)。

### 局部变量表

局部变量表(Local Variable Table)是一组变量值存储空间，用于存放方法参数和方法内部定义的局部变量。

局部变量表的容量以变量槽(Variable Slot)为最小单位。虚拟机规范并没有明确指明一个Slot所占用的内存空间大小，只是很有导向性地说到每个Slot可以存放一个boolean/byte/char/short/int/float/refrence/returnAddress类型的数据。

在方法执行时，虚拟机使用局部变量表完成参数值到参数变量列表的传递，如果执行的是实例方法(非static)，那局部变量表的第0位Slot默认是用于传递方法所属对象实例的引用，即关键字this。

为了节省栈帧空间，Slot是可以复用的，当字节码的PC计数器的值已经超出了某个变量的作用域，那这个变量对应的Slot就可以交给其他变量使用。这样的设计会伴随一些副作用，如系统的GC行为。

局部变量不会像类变量那样存在“准备阶段”：一次赋予系统初始值，一次赋予程序员定义的初始值。所以局部变量不经过初始化是不能使用的。

### 操作数栈

